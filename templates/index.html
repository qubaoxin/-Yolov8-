<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>实时交通监测仪表盘</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{--blue:#0078d7;--card:#fff;--muted:#7f8c8d}
    body{margin:0;font-family:Segoe UI,Arial,Helvetica;background:#f4f7fb;color:#222}
    .app{display:flex;height:100vh}
    .sidebar{width:260px;background:#0f1724;color:#fff;padding:18px;box-sizing:border-box}
    .sidebar h2{color:#39b2ff;margin:0 0 12px}
    .sidebar .section{margin-top:12px}
    .main{flex:1;display:flex;flex-direction:column}
    header{background:var(--card);padding:12px 20px;display:flex;align-items:center;justify-content:space-between;box-shadow:0 2px 8px rgba(0,0,0,0.06)}
    .top-left{display:flex;gap:12px;align-items:center}
    .badge{display:inline-flex;align-items:center;gap:8px}
    .light{width:18px;height:18px;border-radius:50%;display:inline-block;border:2px solid rgba(255,255,255,0.12)}
    .light.red{background:#e53935;box-shadow:0 0 8px rgba(229,57,53,0.6)}
    .light.yellow{background:#f4b400;box-shadow:0 0 8px rgba(244,180,0,0.6)}
    .light.green{background:#2ecc71;box-shadow:0 0 8px rgba(46,204,113,0.6)}
    .content{padding:18px;overflow:auto;flex:1}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:18px}
    .card{background:var(--card);padding:14px;border-radius:10px;box-shadow:0 6px 20px rgba(10,10,10,0.04)}
    .video-wrap{text-align:center}
    .video-wrap img{width:100%;max-width:960px;border-radius:8px}
    .stats-row{display:flex;gap:10px;flex-wrap:wrap}
    .stat{flex:1;min-width:140px;background:#fff;padding:12px;border-radius:8px;text-align:center}
    .stat h3{margin:0;color:var(--blue)}
    .marquee{background:#ff4d4f;color:#fff;padding:8px 12px;border-radius:6px;margin-bottom:12px;display:none}
    .controls input, .controls label{display:block;margin:6px 0}
    footer{padding:12px;text-align:center;color:var(--muted)}
  </style>
</head>
<body>
<div class="app">
  <aside class="sidebar">
    <h2>交通监测仪表盘</h2>
    <div>用户：<strong>{{ username }}</strong></div>
    <div class="section controls">
      <h4 style="color:#9fbff0">检测设置</h4>
      <label>YOLO置信度: <span id="confVal">0.40</span></label>
      <input id="confInput" type="range" min="0.1" max="0.9" step="0.01" value="0.4" />
      <label>检测帧间隔 (skip frames): <span id="skipVal">2</span></label>
      <input id="skipInput" type="range" min="0" max="10" step="1" value="2" />
      <label><input id="lightEnable" type="checkbox" checked /> 启用红绿灯检测</label>
      <button id="saveConf" style="margin-top:8px;padding:8px;border:none;background:var(--blue);color:#fff;border-radius:6px;cursor:pointer">保存设置</button>
    </div>
    <div class="section">
      <h4 style="color:#9fbff0">导航</h4>
      <div><a href="/" style="color:#cfe9ff;text-decoration:none">实时监测</a></div>
      <div style="margin-top:8px"><a href="/logout" style="color:#ffb3b3;text-decoration:none">退出登录</a></div>
    </div>
  </aside>

  <main class="main">
    <header>
      <div class="top-left">
        <h3 style="margin:0">实时交通监测</h3>
        <div style="margin-left:12px;color:#666">演示版 · 实时数据</div>
      </div>
      <div class="badge">
        <div id="light1" class="light unknown" title="红绿灯1"></div>
        <div id="light2" class="light unknown" title="红绿灯2"></div>
      </div>
    </header>

    <div class="content">
      <div id="marquee" class="marquee"></div>

      <div class="grid">
        <div class="card video-wrap">
          <h3>实时视频流</h3>
          <img id="videoFeed" src="/video_feed" alt="video stream" />
        </div>

        <div class="card">
          <h3>车辆总览</h3>
          <div class="stats-row" style="margin-top:12px">
            <div class="stat"><h3>总数</h3><div id="totalCount" style="font-size:22px">0</div></div>
            <div class="stat"><h3>车道变更</h3><div id="laneChanges" style="font-size:22px">0</div></div>
            <div class="stat"><h3>行人闯红灯</h3><div id="pedViolations" style="font-size:22px">0</div></div>
          </div>
        </div>

        <div class="card">
          <h3>车辆类型数量</h3>
          <div style="display:flex;flex-direction:column;gap:8px;margin-top:8px">
            <div>轿车: <strong id="carCount">0</strong></div>
            <div>摩托: <strong id="motorCount">0</strong></div>
            <div>巴士: <strong id="busCount">0</strong></div>
            <div>卡车: <strong id="truckCount">0</strong></div>
            <div>行人: <strong id="personCount">0</strong></div>
          </div>
        </div>

        <div class="card">
          <h3>车道分布（左/中/右）</h3>
          <div style="display:flex;gap:12px;margin-top:10px">
            <div style="flex:1;text-align:center"><div id="lane1" style="font-size:24px">0</div><div style="color:var(--muted)">左</div></div>
            <div style="flex:1;text-align:center"><div id="lane2" style="font-size:24px">0</div><div style="color:var(--muted)">中</div></div>
            <div style="flex:1;text-align:center"><div id="lane3" style="font-size:24px">0</div><div style="color:var(--muted)">右</div></div>
          </div>
        </div>

        <div class="card">
          <h3>车流方向（最近统计）</h3>
          <canvas id="directionChart" height="140"></canvas>
        </div>

        <div class="card">
          <h3>车流量趋势（近50次）</h3>
          <canvas id="trafficTrend" height="140"></canvas>
        </div>

        <div class="card">
          <h3>车道变更趋势</h3>
          <canvas id="laneTrend" height="140"></canvas>
        </div>
      </div>

    </div>

    <footer>实时交通监测系统 · 演示版</footer>
  </main>
</div>

<script>
  // Charts init
  const dirCtx = document.getElementById('directionChart').getContext('2d');
  const trafficCtx = document.getElementById('trafficTrend').getContext('2d');
  const laneCtx = document.getElementById('laneTrend').getContext('2d');

  const directionChart = new Chart(dirCtx, {
    type: 'bar',
    data: { labels: ['left','straight','right'], datasets:[{label:'车辆数', data:[0,0,0], backgroundColor:['#FF6384','#36A2EB','#4BC0C0']}] },
    options:{responsive:true,plugins:{legend:{display:false}}}
  });

  const trafficTrend = new Chart(trafficCtx, {
    type:'line',
    data:{ labels:[], datasets:[
      {label:'轿车', data:[], borderColor:'#FF6384', fill:false},
      {label:'摩托', data:[], borderColor:'#36A2EB', fill:false},
      {label:'巴士', data:[], borderColor:'#4BC0C0', fill:false},
      {label:'卡车', data:[], borderColor:'#FFCD56', fill:false}
    ]},
    options:{responsive:true}
  });

  const laneTrend = new Chart(laneCtx, {
    type:'line',
    data:{ labels:[], datasets:[
      {label:'左道', data:[], borderColor:'#6a9cff', fill:false},
      {label:'中道', data:[], borderColor:'#7ee0b8', fill:false},
      {label:'右道', data:[], borderColor:'#f3b266', fill:false}
    ]},
    options:{responsive:true}
  });

  // helper
  function setLightEl(id, state){
    const el = document.getElementById(id);
    el.className = 'light ' + (state || 'unknown');
  }

  // update loop
  async function fetchAndUpdate(){
    try {
      const res = await fetch('/traffic_data?t=' + Date.now());
      const data = await res.json();

      // lights
      const lights = data.lights || {"light_1":"unknown","light_2":"unknown"};
      setLightEl('light1', lights.light_1);
      setLightEl('light2', lights.light_2);

      // counts
      const counts = data.counts_per_class || {};
      document.getElementById('carCount').innerText = counts.car || counts.car || 0;
      document.getElementById('motorCount').innerText = counts.motorcycle || counts.motor || 0;
      document.getElementById('busCount').innerText = counts.bus || 0;
      document.getElementById('truckCount').innerText = counts.truck || 0;
      document.getElementById('personCount').innerText = counts.person || 0;

      const total = Object.values(counts).reduce((a,b)=>a+(b||0),0);
      document.getElementById('totalCount').innerText = total;

      // lane changes
      const lane_changes = data.lane_changes_per_class || {};
      const totalLaneChanges = Object.values(lane_changes).reduce((a,b)=>a+(b||0),0);
      document.getElementById('laneChanges').innerText = totalLaneChanges;

      // lane counts
      const lanes = data.lane_counts || [];
      document.getElementById('lane1').innerText = lanes[0]?.count || 0;
      document.getElementById('lane2').innerText = lanes[1]?.count || 0;
      document.getElementById('lane3').innerText = lanes[2]?.count || 0;

      // directions
      const dir = data.direction_summary || {};
      directionChart.data.datasets[0].data = [dir.left||0, dir.straight||0, dir.right||0];
      directionChart.update();

      // violations -> marquee
      const viols = data.violations || [];
      const marquee = document.getElementById('marquee');
      if(viols.length>0){
        marquee.style.display = 'block';
        marquee.innerText = viols.map(v=>v.msg).join("  ||  ");
        document.getElementById('pedViolations').innerText = viols.filter(v=>v.type==='pedestrian_red_cross').length;
      } else {
        marquee.style.display = 'none';
        document.getElementById('pedViolations').innerText = 0;
      }

      // update trend charts (append time label)
      const tlabel = new Date().toLocaleTimeString();
      function pushSeries(chart, values){
        chart.data.labels.push(tlabel);
        chart.data.datasets.forEach((ds,i)=>{ ds.data.push(values[i]||0); if(ds.data.length>50) ds.data.shift(); });
        if(chart.data.labels.length>50) chart.data.labels.shift();
        chart.update();
      }
      pushSeries(trafficTrend, [
        counts.car||0, counts.motorcycle||0, counts.bus||0, counts.truck||0
      ]);
      pushSeries(laneTrend, [
        lanes[0]?.count||0, lanes[1]?.count||0, lanes[2]?.count||0
      ]);

    } catch (e) {
      console.error(e);
    }
  }

  // initial fetch and interval
  fetchAndUpdate();
  setInterval(fetchAndUpdate, 1500);

  // config controls
  const confInput = document.getElementById('confInput');
  const confVal = document.getElementById('confVal');
  confInput.oninput = ()=>confVal.innerText = confInput.value;
  const skipInput = document.getElementById('skipInput');
  const skipVal = document.getElementById('skipVal');
  skipInput.oninput = ()=>skipVal.innerText = skipInput.value;

  document.getElementById('saveConf').onclick = async ()=>{
    const payload = {
      conf_thresh: parseFloat(confInput.value),
      skip_frames: parseInt(skipInput.value),
      enable_light_detection: document.getElementById('lightEnable').checked,
      white_line_y_rel: 0.72
    };
    await fetch('/config',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    alert('设置已保存');
  };
</script>
</body>
</html>
