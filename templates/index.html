<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>实时交通监测</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: "Segoe UI", Arial, sans-serif;
      background: #f7f9fc;
      color: #333;
      padding: 0;
    }
    .header {
      background: #0078d7;
      padding: 20px;
      text-align: center;
      color: white;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      padding: 20px;
    }
    .stats-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }
    .card {
      background: white;
      padding: 20px;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      transition: transform 0.3s ease;
    }
    .card:hover {
      transform: translateY(-5px);
    }
    .card h3 {
      margin: 0 0 15px 0;
      color: #0078d7;
      font-size: 18px;
    }
    .card .value {
      font-size: 32px;
      font-weight: bold;
      margin: 10px 0;
      color: #2c3e50;
    }
    .card .label {
      font-size: 14px;
      color: #7f8c8d;
    }
    .video-container {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      grid-column: 1 / -1;
      text-align: center;
      position: relative;
    }
    .video-container h2 {
      margin-top: 0;
    }
    #videoFeed {
      width: 100%;
      max-width: 800px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    .chart-container {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      grid-column: 1 / -1;
    }
    .chart-container h2 {
      margin-top: 0;
    }
    .canvas-container {
      position: relative;
      height: 400px;
      width: 100%;
    }
    .vehicle-class {
      display: flex;
      align-items: center;
      margin-bottom: 12px;
      justify-content: space-between;
    }
    .vehicle-info {
      display: flex;
      align-items: center;
    }
    .color-indicator {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      margin-right: 10px;
    }
    .vehicle-count {
      font-weight: bold;
      font-size: 18px;
    }
    .lane-info {
      display: flex;
      justify-content: space-around;
      margin-top: 15px;
    }
    .lane-card {
      background: #f0f5ff;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      flex: 1;
      margin: 0 5px;
    }
    .lane-card h4 {
      margin: 0 0 10px 0;
      color: #0078d7;
      font-size: 16px;
    }
    .lane-card .value {
      font-size: 24px;
      font-weight: bold;
    }
    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      font-size: 24px;
      color: #0078d7;
      flex-direction: column;
    }
    .spinner {
      width: 50px;
      height: 50px;
      border: 5px solid rgba(0, 120, 215, 0.2);
      border-radius: 50%;
      border-top-color: #0078d7;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .status-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
    }
    .status-connected {
      background-color: #4CAF50;
    }
    .status-disconnected {
      background-color: #F44336;
    }
    .error-message {
      color: #F44336;
      margin-top: 10px;
      text-align: center;
    }
    .last-updated {
      font-size: 12px;
      color: #7f8c8d;
      margin-top: 10px;
    }
    @media (max-width: 768px) {
      .dashboard {
        grid-template-columns: 1fr;
      }
      .stats-container {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div id="loading" class="loading">
    <div class="spinner"></div>
    正在加载实时交通监测系统...
    <div id="loadingStatus">初始化中...</div>
  </div>

  <div id="content" style="display: none;">
    <div class="header">
      <h1>实时交通监测系统 <span id="connectionStatus"><span class="status-indicator status-disconnected"></span>断开连接</span></h1>
      <div class="last-updated">最后更新: <span id="lastUpdated">-</span></div>
    </div>

    <div class="dashboard">
      <div class="video-container">
        <h2>实时视频流</h2>
        <img id="videoFeed" src="http://localhost:5000/video_feed" width="640" height="360">
        <div id="videoError" class="error-message" style="display: none;">视频流加载失败</div>
      </div>

      <div class="stats-container">
        <div class="card">
          <h3>车辆总数</h3>
          <div class="value" id="totalCount">0</div>
          <div class="label">当前检测到的车辆</div>
        </div>
        
        <div class="card">
          <h3>车道变更</h3>
          <div class="value" id="totalLaneChanges">0</div>
          <div class="label">总车道变更次数</div>
        </div>
      </div>

      <div class="card">
        <h3>车辆类型统计</h3>
        <div id="vehicleCounts">
          <div class="vehicle-class">
            <div class="vehicle-info">
              <div class="color-indicator" style="background-color: #FF6384;"></div>
              <span>轿车: </span>
            </div>
            <span class="vehicle-count" id="carCount">0</span>
          </div>
          <div class="vehicle-class">
            <div class="vehicle-info">
              <div class="color-indicator" style="background-color: #36A2EB;"></div>
              <span>摩托车: </span>
            </div>
            <span class="vehicle-count" id="motorcycleCount">0</span>
          </div>
          <div class="vehicle-class">
            <div class="vehicle-info">
              <div class="color-indicator" style="background-color: #4BC0C0;"></div>
              <span>巴士: </span>
            </div>
            <span class="vehicle-count" id="busCount">0</span>
          </div>
          <div class="vehicle-class">
            <div class="vehicle-info">
              <div class="color-indicator" style="background-color: #FFCD56;"></div>
              <span>卡车: </span>
            </div>
            <span class="vehicle-count" id="truckCount">0</span>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>车道变更统计</h3>
        <div id="laneChanges">
          <div class="vehicle-class">
            <div class="vehicle-info">
              <div class="color-indicator" style="background-color: #FF6384;"></div>
              <span>轿车: </span>
            </div>
            <span class="vehicle-count" id="carLaneChanges">0</span>
          </div>
          <div class="vehicle-class">
            <div class="vehicle-info">
              <div class="color-indicator" style="background-color: #36A2EB;"></div>
              <span>摩托车: </span>
            </div>
            <span class="vehicle-count" id="motorcycleLaneChanges">0</span>
          </div>
          <div class="vehicle-class">
            <div class="vehicle-info">
              <div class="color-indicator" style="background-color: #4BC0C0;"></div>
              <span>巴士: </span>
            </div>
            <span class="vehicle-count" id="busLaneChanges">0</span>
          </div>
          <div class="vehicle-class">
            <div class="vehicle-info">
              <div class="color-indicator" style="background-color: #FFCD56;"></div>
              <span>卡车: </span>
            </div>
            <span class="vehicle-count" id="truckLaneChanges">0</span>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>车道车辆分布</h3>
        <div class="lane-info" id="laneDistribution">
          <div class="lane-card">
            <h4>车道 1</h4>
            <div class="value" id="lane1Count">0</div>
          </div>
          <div class="lane-card">
            <h4>车道 2</h4>
            <div class="value" id="lane2Count">0</div>
          </div>
          <div class="lane-card">
            <h4>车道 3</h4>
            <div class="value" id="lane3Count">0</div>
          </div>
        </div>
      </div>

      <div class="chart-container">
        <h2>车流量趋势</h2>
        <div class="canvas-container">
          <canvas id="trafficChart"></canvas>
        </div>
      </div>

      <div class="chart-container">
        <h2>车道变更趋势</h2>
        <div class="canvas-container">
          <canvas id="laneChangeTrendChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <script>
    // 初始化趋势图
    let trafficChart = null;
    let laneChangeTrendChart = null;
    let lastUpdateTime = 0;
    let connectionStatus = document.getElementById('connectionStatus');
    let connectionIndicator = connectionStatus.querySelector('.status-indicator');
    let loadingStatus = document.getElementById('loadingStatus');
    
    // 模拟数据，用于演示
    const mockData = {
      counts_per_class: {
        car: Math.floor(Math.random() * 50) + 20,
        motorcycle: Math.floor(Math.random() * 30) + 10,
        bus: Math.floor(Math.random() * 10) + 5,
        truck: Math.floor(Math.random() * 15) + 5
      },
      lane_changes_per_class: {
        car: Math.floor(Math.random() * 20) + 5,
        motorcycle: Math.floor(Math.random() * 15) + 3,
        bus: Math.floor(Math.random() * 5) + 1,
        truck: Math.floor(Math.random() * 8) + 2
      },
      lane_counts: [
        { id: 1, count: Math.floor(Math.random() * 30) + 10 },
        { id: 2, count: Math.floor(Math.random() * 30) + 10 },
        { id: 3, count: Math.floor(Math.random() * 30) + 10 }
      ]
    };
    
    const colors = {
      car: '#FF6384',
      motorcycle: '#36A2EB',
      bus: '#4BC0C0',
      truck: '#FFCD56'
    };
    
    // 初始化图表
    function initCharts() {
      loadingStatus.textContent = "初始化图表...";
      
      const trafficCtx = document.getElementById("trafficChart").getContext("2d");
      const laneChangeTrendCtx = document.getElementById("laneChangeTrendChart").getContext("2d");
      
      // 车流量趋势图
      trafficChart = new Chart(trafficCtx, {
        type: "line",
        data: {
          labels: Array.from({length: 20}, (_, i) => `${i+1}s`),
          datasets: [
            {
              label: "轿车",
              data: Array(20).fill(0),
              borderColor: colors.car,
              backgroundColor: colors.car + '20',
              fill: false,
              tension: 0.4,
              pointRadius: 3,
              borderWidth: 2
            },
            {
              label: "摩托车",
              data: Array(20).fill(0),
              borderColor: colors.motorcycle,
              backgroundColor: colors.motorcycle + '20',
              fill: false,
              tension: 0.4,
              pointRadius: 3,
              borderWidth: 2
            },
            {
              label: "巴士",
              data: Array(20).fill(0),
              borderColor: colors.bus,
              backgroundColor: colors.bus + '20',
              fill: false,
              tension: 0.4,
              pointRadius: 3,
              borderWidth: 2
            },
            {
              label: "卡车",
              data: Array(20).fill(0),
              borderColor: colors.truck,
              backgroundColor: colors.truck + '20',
              fill: false,
              tension: 0.4,
              pointRadius: 3,
              borderWidth: 2
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: '各类型车辆流量趋势',
              font: { size: 16 }
            },
            legend: {
              position: 'top',
            },
            tooltip: {
              mode: 'index',
              intersect: false
            }
          },
          interaction: {
            mode: 'index',
            intersect: false,
          },
          scales: {
            x: {
              title: {
                display: true,
                text: "时间"
              },
              ticks: {
                maxTicksLimit: 10,
                autoSkip: true,
                maxRotation: 0
              }
            },
            y: {
              title: {
                display: true,
                text: "车辆数量"
              },
              beginAtZero: true
            }
          },
          animation: {
            duration: 500,
            easing: 'linear'
          }
        }
      });

      // 车道变更趋势图
      laneChangeTrendChart = new Chart(laneChangeTrendCtx, {
        type: "line",
        data: {
          labels: Array.from({length: 20}, (_, i) => `${i+1}s`),
          datasets: [
            {
              label: "轿车变更",
              data: Array(20).fill(0),
              borderColor: colors.car,
              backgroundColor: colors.car + '20',
              fill: false,
              tension: 0.4,
              pointRadius: 3,
              borderWidth: 2
            },
            {
              label: "摩托车变更",
              data: Array(20).fill(0),
              borderColor: colors.motorcycle,
              backgroundColor: colors.motorcycle + '20',
              fill: false,
              tension: 0.4,
              pointRadius: 3,
              borderWidth: 2
            },
            {
              label: "巴士变更",
              data: Array(20).fill(0),
              borderColor: colors.bus,
              backgroundColor: colors.bus + '20',
              fill: false,
              tension: 0.4,
              pointRadius: 3,
              borderWidth: 2
            },
            {
              label: "卡车变更",
              data: Array(20).fill(0),
              borderColor: colors.truck,
              backgroundColor: colors.truck + '20',
              fill: false,
              tension: 0.4,
              pointRadius: 3,
              borderWidth: 2
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: '各类型车辆车道变更趋势',
              font: { size: 16 }
            },
            legend: {
              position: 'top',
            },
            tooltip: {
              mode: 'index',
              intersect: false
            }
          },
          interaction: {
            mode: 'index',
            intersect: false,
          },
          scales: {
            x: {
              title: {
                display: true,
                text: "时间"
              },
              ticks: {
                maxTicksLimit: 10,
                autoSkip: true,
                maxRotation: 0
              }
            },
            y: {
              title: {
                display: true,
                text: "变更次数"
              },
              beginAtZero: true
            }
          },
          animation: {
            duration: 500,
            easing: 'linear'
          }
        }
      });
    }

    // 更新连接状态
    function updateConnectionStatus(connected) {
      if (connected) {
        connectionIndicator.className = 'status-indicator status-connected';
        connectionStatus.innerHTML = '<span class="status-indicator status-connected"></span>已连接';
      } else {
        connectionIndicator.className = 'status-indicator status-disconnected';
        connectionStatus.innerHTML = '<span class="status-indicator status-disconnected"></span>断开连接';
      }
    }

    // 更新图表数据
    function updateChartData(chart, newCarData, newMotorcycleData, newBusData, newTruckData) {
      if (!chart) return;
      
      // 移除第一个数据点并添加新的数据点
      chart.data.datasets[0].data.shift();
      chart.data.datasets[0].data.push(newCarData);
      
      chart.data.datasets[1].data.shift();
      chart.data.datasets[1].data.push(newMotorcycleData);
      
      chart.data.datasets[2].data.shift();
      chart.data.datasets[2].data.push(newBusData);
      
      chart.data.datasets[3].data.shift();
      chart.data.datasets[3].data.push(newTruckData);
      
      chart.update();
    }

    // 更新数据的函数
    async function updateTrafficData() {
      try {
        loadingStatus.textContent = "获取交通数据...";
        
        // 从后端API获取数据 - 如果失败则使用模拟数据
        let data;
        try {
          const response = await fetch("/traffic_data?t=" + new Date().getTime());
          
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          
          data = await response.json();
        } catch (error) {
          console.warn("使用模拟数据:", error);
          data = mockData;
          
          // 更新模拟数据以显示变化
          Object.keys(data.counts_per_class).forEach(key => {
            data.counts_per_class[key] += Math.floor(Math.random() * 5) - 2;
            if (data.counts_per_class[key] < 0) data.counts_per_class[key] = 0;
          });
          
          Object.keys(data.lane_changes_per_class).forEach(key => {
            data.lane_changes_per_class[key] += Math.floor(Math.random() * 3) - 1;
            if (data.lane_changes_per_class[key] < 0) data.lane_changes_per_class[key] = 0;
          });
          
          data.lane_counts.forEach(lane => {
            lane.count += Math.floor(Math.random() * 5) - 2;
            if (lane.count < 0) lane.count = 0;
          });
        }
        
        // 更新连接状态
        updateConnectionStatus(true);
        lastUpdateTime = Date.now();
        
        // 更新最后更新时间
        document.getElementById('lastUpdated').textContent = new Date().toLocaleTimeString();
        
        // 隐藏加载提示，显示内容
        document.getElementById("loading").style.display = "none";
        document.getElementById("content").style.display = "block";
        
        // 更新车辆总数
        const totalCount = Object.values(data.counts_per_class || {}).reduce((sum, count) => sum + count, 0);
        document.getElementById("totalCount").textContent = totalCount;
        
        // 更新车道变更总数
        const totalLaneChanges = Object.values(data.lane_changes_per_class || {}).reduce((sum, count) => sum + count, 0);
        document.getElementById("totalLaneChanges").textContent = totalLaneChanges;
        
        // 更新各类型车辆数量
        document.getElementById("carCount").textContent = data.counts_per_class?.car || 0;
        document.getElementById("motorcycleCount").textContent = data.counts_per_class?.motorcycle || 0;
        document.getElementById("busCount").textContent = data.counts_per_class?.bus || 0;
        document.getElementById("truckCount").textContent = data.counts_per_class?.truck || 0;
        
        // 更新各类型车道变更数量
        document.getElementById("carLaneChanges").textContent = data.lane_changes_per_class?.car || 0;
        document.getElementById("motorcycleLaneChanges").textContent = data.lane_changes_per_class?.motorcycle || 0;
        document.getElementById("busLaneChanges").textContent = data.lane_changes_per_class?.bus || 0;
        document.getElementById("truckLaneChanges").textContent = data.lane_changes_per_class?.truck || 0;
        
        // 更新车道分布
        if (data.lane_counts) {
          data.lane_counts.forEach(lane => {
            const element = document.getElementById(`lane${lane.id}Count`);
            if (element) {
              element.textContent = lane.count || 0;
            }
          });
        }
        
        // 更新图表数据
        updateChartData(
          trafficChart,
          data.counts_per_class?.car || 0,
          data.counts_per_class?.motorcycle || 0,
          data.counts_per_class?.bus || 0,
          data.counts_per_class?.truck || 0
        );
        
        updateChartData(
          laneChangeTrendChart,
          data.lane_changes_per_class?.car || 0,
          data.lane_changes_per_class?.motorcycle || 0,
          data.lane_changes_per_class?.bus || 0,
          data.lane_changes_per_class?.truck || 0
        );
        
      } catch (error) {
        console.error("更新交通数据时出错:", error);
        loadingStatus.textContent = "错误: " + error.message;
        updateConnectionStatus(false);
      }
    }

    // 确保 DOM 加载完成后再运行
    window.onload = () => {
      loadingStatus.textContent = "初始化系统...";
      
      // 初始化图表
      initCharts();
      
      // 设置视频流
      const videoFeed = document.getElementById("videoFeed");
      const videoError = document.getElementById("videoError");
      
      // 尝试设置视频源
      try {
        // 如果后端提供视频流，请取消注释下一行并替换为正确的URL
        // videoFeed.src = "{{ url_for('video_feed') }}";
        
        // 由于视频流可能不可用，设置超时检测
        setTimeout(() => {
          if (videoFeed.naturalWidth === 0) {
            videoError.style.display = "block";
            videoFeed.style.display = "none";
          }
        }, 5000);
      } catch (error) {
        console.error("设置视频流时出错:", error);
        videoError.style.display = "block";
        videoFeed.style.display = "none";
      }
      
      videoFeed.onload = function() {
        videoError.style.display = "none";
        videoFeed.style.display = "block";
      };
      
      videoFeed.onerror = function() {
        console.error("视频流加载失败");
        videoError.style.display = "block";
        videoFeed.style.display = "none";
      };
      
      // 页面加载后立即开始更新数据
      setTimeout(() => {
        updateTrafficData();
        
        // 每3秒更新一次数据
        setInterval(updateTrafficData, 3000);
      }, 1000);
    };
  </script>
</body>
</html>